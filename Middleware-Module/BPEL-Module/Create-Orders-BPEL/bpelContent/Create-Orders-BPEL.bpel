<!-- Create-Orders-BPEL BPEL Process [Generated by the Eclipse BPEL Designer]  -->
<!-- Date: Mon Mar 05 12:18:58 IST 2012 -->

<bpel:process xmlns:tns="http://touresbalon.com.co/orders/service/task/1.0.0"
              xmlns:ode="http://www.apache.org/ode/type/extension"
              xmlns:credit="http://redeban.com/creditcards/ws"
              xmlns:transport="http://touresbalon.com.co/transport/service/task/1.0.0"
              xmlns:spectacle="http://spectacles.com.co/service/task/1.0.0"
              xmlns:lodging="http://touresbalon.com.co/task/lodging/v1"
              xmlns:lodging1="http://touresbalon.com.co/task/lodging/schema/v1"
              xmlns:lodging2="http://touresbalon.com.co/model/lodging/schema/v1"
              xmlns:email="http://tempuri.org/"
              xmlns:so="http://touresbalon.com.co/salesorder/service/task/1.0.0"
              xmlns:rules="http://touresbalon.com.co/businessrules/service/utility/1.0.0"
              xmlns:ht="http://touresbalon.com.co/salesorder/service/utility/1.0.0"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:error="http://touresbalon.com.co/auditor/service/entity/1.0.0"
              xmlns:canonical="http://touresbalon.com.co/model/canonical/1.0.0"
              xmlns:microfocus="http://touresbalon.com.co/accounting/service/entity/1.0.0"
              name="Create-Orders-BPEL"
              targetNamespace="http://touresbalon.com.co/orders/service/task/1.0.0"
              suppressJoinFailure="yes" xmlns:b4p="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
              xmlns:htschema="http://touresbalon.com.co/salesorder/schema/utility/1.0.0" xmlns:ns="http://touresbalon.com.co/task/lodging/schema/v1" xmlns:xsd="http://schemas.datacontract.org/2004/07/Email_Services.microsoft.co.com.touresbalon.foundation.email.entity">

    <!-- BPEL4People extension activity -->
    <bpel:extensions>
        <bpel:extension
                namespace="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
                mustUnderstand="yes"/>
    </bpel:extensions>

    <!-- Import the client WSDL -->

    <bpel:import namespace="http://touresbalon.com.co/salesorder/service/utility/1.0.0"
                 location="wsdl/SalesOrderApprovalTaskService.wsdl"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
    <bpel:import namespace="http://touresbalon.com.co/model/canonical/1.0.0"
                 location="canonical_schema.xsd"
                 importType="http://www.w3.org/2001/XMLSchema"/>

    <bpel:import location="Create-Orders-Process.wsdl"
                 namespace="http://touresbalon.com.co/orders/service/task/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <bpel:import location="wsdl/CreditCard.wsdl"
                 namespace="http://redeban.com/creditcards/ws"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <bpel:import location="wsdl/TransportWS.wsdl"
                 namespace="http://touresbalon.com.co/transport/service/task/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <bpel:import location="wsdl/SpectaclesWS.wsdl"
                 namespace="http://spectacles.com.co/service/task/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
                 
                 
    <bpel:import location="wsdl/LodgingService.wsdl"
                 namespace="http://touresbalon.com.co/task/lodging/v1"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
     
    <bpel:import location="wsdl/SalesOrderWS.wsdl"
                 namespace="http://touresbalon.com.co/salesorder/service/task/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <bpel:import location="wsdl/BusinessRulesWS.wsdl"
                 namespace="http://touresbalon.com.co/businessrules/service/utility/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <bpel:import location="wsdl/SalesOrderApprovalTaskService.wsdl"
                 namespace="http://touresbalon.com.co/salesorder/service/utility/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
                 
   <bpel:import location="wsdl/EmailServiceSend.wsdl"
                 namespace="http://tempuri.org/"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
                 
   <bpel:import location="wsdl/Microfocus.wsdl"
                 namespace="http://touresbalon.com.co/accounting/service/entity/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>
                          
                 
   <bpel:import location="wsdl/OrderProccessingError.wsdl"
                 namespace="http://touresbalon.com.co/auditor/service/entity/1.0.0"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <!-- ================================================================= -->
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->

    <bpel:partnerLinks>

        <bpel:partnerLink name="client"
                          partnerLinkType="tns:Create-Orders-BPEL"
                          myRole="Create-Orders-BPELProvider"/>

        <bpel:partnerLink name="CreditCardPartnerLink"
                          partnerLinkType="credit:CreditCard_PLT"
                          partnerRole="CreditCard_Role"
                          initializePartnerRole="yes"/>

        <bpel:partnerLink name="TransportWSPartnerLink"
                          partnerLinkType="transport:TransportWS_PLT"
                          partnerRole="TransportWS_Role"
                          initializePartnerRole="yes"/>

        <bpel:partnerLink name="SpectaclesWSPartnerLink"
                          partnerLinkType="spectacle:SpectaclesWS_PLT"
                          partnerRole="SpectaclesWS_Role"
                          initializePartnerRole="yes"/>
                          
    	<bpel:partnerLink name="LodgingWSPartnerLink"
                          partnerLinkType="lodging:LodgingWS_PLT"
                          partnerRole="LodgingWS_Role"
                          initializePartnerRole="yes"/>

        <bpel:partnerLink name="SalesOrderWSPartnerLink"
                          partnerLinkType="so:SalesOrderWS_PLT"
                          partnerRole="SalesOrderWS_Role"
                          initializePartnerRole="yes"/>

        <bpel:partnerLink name="BusinessRulesWSPartnerLink"
                          partnerLinkType="rules:BusinessRulesWS_PLT"
                          partnerRole="BusinessRulesWS_Role"
                          initializePartnerRole="yes"/>
                          
   	    <bpel:partnerLink name="EmailServiceWSPartnerLink"
                          partnerLinkType="email:EmailServiceWS_PLT"
                          partnerRole="EmailServiceWS_Role"
                          initializePartnerRole="yes"/>

   	    <bpel:partnerLink name="OrderProcessingErrorWSPartnerLink"
                          partnerLinkType="error:OrderProcessingErrorWS_PLT"
                          partnerRole="OrderProcessingErrorWS_Role"
                          initializePartnerRole="yes"/>
                          
       <bpel:partnerLink name="MicrofocusWSPartnerLink"
                          partnerLinkType="microfocus:MicrofocusWS_PLT"
                          partnerRole="MicrofocusWS_Role"
                          initializePartnerRole="yes"/>

        <bpel:partnerLink name="b4pPartnerLink"
                          partnerLinkType="ht:b4pPartnerLinkType"
                          partnerRole="remoteRole"
                          myRole="localRol"
                          initializePartnerRole="yes"/>
    </bpel:partnerLinks>

    <!-- ================================================================= -->
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->

    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                       messageType="tns:CreateSalesOrderRequest-Message"/>
        <bpel:variable name="validateCCInput"
                       messageType="credit:validateCreditCard"/>
        <bpel:variable name="validateCCOutput"
                       messageType="credit:validateCreditCardResponse"/>
        <bpel:variable name="validateTransportInput"
                       messageType="transport:generateReservation"/>
        <bpel:variable name="validateTransportOutput"
                       messageType="transport:generateReservationResponse"/>
		<bpel:variable name="counter"
                       element="canonical:IteratorCounter"/>
        <bpel:variable name="evaluation"
                       element="canonical:EvaluationResponse"/>
        <bpel:variable name="compTransportInput"
                       messageType="transport:cancelReservation"/>
        <bpel:variable name="journal"
                       element="canonical:JournalProvisioning"/>
        <bpel:variable name="stock"
                       element="canonical:stock"/>

        <bpel:variable name="confirmTransportInput"
                       messageType="transport:confirmTravel"/>
        <bpel:variable name="searchTicketInput"
                       messageType="spectacle:searchTicketByIdSpectacle"/>
        <bpel:variable name="searchTicketOutput"
                       messageType="spectacle:searchTicketByIdSpectacleResponse"/>
        <bpel:variable name="cancelSpectacleInput"
                       messageType="spectacle:cancelSpectacleReservation"/>
        <bpel:variable name="cancelSpectacleOutput"
                       messageType="spectacle:cancelSpectacleReservationResponse"/>
        <bpel:variable name="confirmSpectacleInput"
                       messageType="spectacle:buySpectacleByTicket"/>
        <bpel:variable name="confirmSpectacleOutput"
                       messageType="spectacle:buySpectacleByTicketResponse"/>
        <bpel:variable name="createOrderInput"
                       messageType="so:createSalesOrder"/>
        <bpel:variable name="createOrderOutput"
                       messageType="so:createSalesOrderResponse"/>
        <bpel:variable name="updateItemInput"
                       messageType="so:updateItem"/>
        <bpel:variable name="evaluateBusinessRuleInput"
                       messageType="rules:evaluateRule"/>
        <bpel:variable name="evaluateBusinessRuleOutput"
                       messageType="rules:evaluateRuleResponse"/>
        <bpel:variable name="updateOrderStatusInput"
                       messageType="so:changeSalesOrderStatus"/>
        <bpel:variable name="completeOrderStatusInput"
                       messageType="so:changeSalesOrderStatus"/>
        <bpel:variable name="claimInput"
                       messageType="ht:ClaimApprovalRequest"/>
        <bpel:variable name="claimOutput"
                       messageType="ht:ClaimApprovalResponse"/>
                       
        <bpel:variable name="validateLodgingInput" messageType="lodging:consultRoomsAvailability"></bpel:variable>
        <bpel:variable name="validateLodgingOutput" messageType="lodging:consultRoomsAvailabilityResponse"></bpel:variable>
        
        <bpel:variable name="compLodgingInput" messageType="lodging:cancelReservation"></bpel:variable>
        <bpel:variable name="compLodgingOutput" messageType="lodging:cancelReservationResponse"></bpel:variable>
        
        <bpel:variable name="confirmLodgingInput" messageType="lodging:confirmReservation"></bpel:variable>
        <bpel:variable name="conformLodgingOutput" messageType="lodging:confirmReservationResponse"></bpel:variable>
        
        <bpel:variable name="emailSendInput" messageType="email:IEmailService_sendMailToCustomer_InputMessage"></bpel:variable>
        <bpel:variable name="emailSendOutput" messageType="email:IEmailService_sendMailToCustomer_OutputMessage"></bpel:variable>

        <bpel:variable name="orderProccesingErrorInput" messageType="error:orderProcessingErrorRequestMessage"></bpel:variable>

        <bpel:variable name="createCompletedOrderInput" messageType="microfocus:createCompletedOrder"></bpel:variable>
        <bpel:variable name="createExecutedPaymentInput" messageType="microfocus:createExecutedPayment"></bpel:variable>

        <bpel:variable name="executePaymentInput" messageType="credit:executeTransaction"></bpel:variable>

    </bpel:variables>

    <!-- ================================================================= -->
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->

    <bpel:sequence name="MAIN">

        <!-- Receive input from requestor. 
             Note: This maps to operation defined in Create-Orders-BPEL.wsdl 
             -->


        <bpel:receive name="receiveInput" partnerLink="client"
                      portType="tns:Create-Orders-BPEL"
                      operation="process" variable="input"
                      createInstance="yes"/>


        <!-- ================================================================= -->
        <!-- VALIDATION STAGE                                                  -->
        <!-- Stage required to process de product availability validation      -->
        <!-- ================================================================= -->

        <bpel:sequence name="VALIDATION_STAGE">

            <bpel:assign validate="no" name="Assign-variable-init">
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>
                            <tns:JournalProvisioning xmlns:tns="http://touresbalon.com.co/model/canonical/1.0.0">
                            </tns:JournalProvisioning>
                        </bpel:literal>
                    </bpel:from>
                    <bpel:to variable="journal"></bpel:to>
                </bpel:copy>

                <bpel:copy>
                    <bpel:from>
                        <![CDATA[bpel:doXslTransform("xslt/createOrderRequest.xsl", $input.payload)]]>
                    </bpel:from>
                    <bpel:to variable="createOrderInput" part="parameters"/>
                </bpel:copy>

            </bpel:assign>

            
            <bpel:assign validate="no" name="Assign-input-email">
                <bpel:copy>
                    <bpel:from><bpel:literal>	  <tns:sendMailToCustomer xmlns:tns="http://tempuri.org/" xmlns:tns1="http://schemas.datacontract.org/2004/07/Email_Services.microsoft.co.com.touresbalon.foundation.email.entity" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
 <tns:email>
            <tns1:Id></tns1:Id>
            <tns1:body></tns1:body>
            <tns1:email></tns1:email>
            <tns1:first_name></tns1:first_name>
            <tns1:footer></tns1:footer>
            <tns1:last_name></tns1:last_name>
            <tns1:messageSend></tns1:messageSend>
            <tns1:subject></tns1:subject>
         </tns:email>
</tns:sendMailToCustomer></bpel:literal></bpel:from>
                    <bpel:to variable="emailSendInput" part="parameters"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/custFirstName]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="emailSendInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[email:email/xsd:first_name]]>
                        </bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/custLastName]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="emailSendInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:last_name]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>Toures Balon</bpel:literal>
                    </bpel:from>
                    <bpel:to part="parameters" variable="emailSendInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:messageSend]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/email]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="emailSendInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:email]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>Universidad Javeriana
</bpel:literal>
                    </bpel:from>
                    <bpel:to part="parameters" variable="emailSendInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:footer]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>
            
            
            <bpel:assign validate="no" name="Assign-input-error">
                <bpel:copy>
                    <bpel:from><bpel:literal><tns:orderProcessingErrorRequest xmlns:tns="http://touresbalon.com.co/auditor/service/entity/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:oderId>0</tns:oderId>
<tns:comments>Comentarios</tns:comments>
  <tns:orderRequest>tns:orderRequest</tns:orderRequest>
</tns:orderProcessingErrorRequest></bpel:literal></bpel:from>
                    <bpel:to variable="orderProccesingErrorInput" part="payload"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload]]>
                    </bpel:from>
                    <bpel:to part="payload" variable="orderProccesingErrorInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[error:orderRequest]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>
            <bpel:invoke name="Invoke-error" partnerLink="OrderProcessingErrorWSPartnerLink" operation="pushOrder" portType="error:orderProcessingErrorPort" inputVariable="orderProccesingErrorInput"></bpel:invoke>
            <bpel:sequence name="VALIDATE_CREDIT_CARD">
                <bpel:assign validate="no" name="Assign-Input">
                    <bpel:copy>
                        <bpel:from>
                            <bpel:literal>
                                <tns:validateCreditCard xmlns:tns="http://redeban.com/creditcards/ws">
                                    <person>
                                        <identificationType/>
                                        <numberCreditCard/>
                                        <numberIdentification/>
                                    </person>
                                </tns:validateCreditCard>
                            </bpel:literal>
                        </bpel:from>
                        <bpel:to variable="validateCCInput" part="parameters"/>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[order/custDocumentNumber]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="validateCCInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[person/numberIdentification]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>

                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[order/custDocumentType]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="validateCCInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[person/identificationType]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[order/creditCardNumber]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="validateCCInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[person/numberCreditCard]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>

                <bpel:invoke name="InvokeCreditCardValidation" partnerLink="CreditCardPartnerLink"
                             operation="validateCreditCard" portType="credit:CreditCard" inputVariable="validateCCInput"
                             outputVariable="validateCCOutput"/>

                <bpel:if name="If-credit-card-is-not-valid">
                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$validateCCOutput.parameters/return = 'false']]></bpel:condition>
                    <bpel:sequence name="Sequence-cancel-order">

                        <bpel:assign validate="no" name="Assign-order-comments">
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>The credit card is invalid</bpel:literal>
                                </bpel:from>
                                <bpel:to part="parameters" variable="createOrderInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/comments]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        <bpel:invoke name="Invoke-create-order" partnerLink="SalesOrderWSPartnerLink"
                                     operation="createSalesOrder" portType="so:SalesOrderWS"
                                     inputVariable="createOrderInput" outputVariable="createOrderOutput"></bpel:invoke>
                        
                        <bpel:sequence name="Sequence"><bpel:assign validate="no" name="Assign-input-email">
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Su orde esta no fue aprobada</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:body]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Estado de la orden</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:subject]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                            </bpel:assign>
                            <bpel:invoke name="Invoke-email-cancel" partnerLink="EmailServiceWSPartnerLink" operation="sendMailToCustomer" portType="email:IEmailService" inputVariable="emailSendInput" outputVariable="emailSendOutput"></bpel:invoke>
                        
                        </bpel:sequence>
                        <bpel:exit name="Exit-cancel-order"></bpel:exit>
                        
                    </bpel:sequence>
                    <bpel:else>
                        <bpel:invoke name="Invoke-create-order" partnerLink="SalesOrderWSPartnerLink"
                                     operation="createSalesOrder" portType="so:SalesOrderWS"
                                     inputVariable="createOrderInput" outputVariable="createOrderOutput"></bpel:invoke>
                    </bpel:else>

                </bpel:if>

            </bpel:sequence>
            <bpel:sequence name="VALIDATE-CUSTOMER-BUSINESS-RULES">
                <bpel:assign validate="no" name="Assign-input">
                    <bpel:copy>
                        <bpel:from>
                            <bpel:literal>
                                <tns:evaluateRule
                                        xmlns:tns="http://touresbalon.com.co/businessrules/service/utility/1.0.0"
                                        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                    <fact>
                                        <approval>true</approval>
                                        <orderAmount>0</orderAmount>
                                        <userType>userType</userType>
                                    </fact>
                                </tns:evaluateRule>
                            </bpel:literal>
                        </bpel:from>
                        <bpel:to variable="evaluateBusinessRuleInput" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[order/customerType]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="evaluateBusinessRuleInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[fact/userType]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[order/price]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="evaluateBusinessRuleInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[fact/orderAmount]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="Invoke-business-rule-approval-evaluation" partnerLink="BusinessRulesWSPartnerLink"
                             operation="evaluateRule" portType="rules:BusinessRulesWS"
                             inputVariable="evaluateBusinessRuleInput"
                             outputVariable="evaluateBusinessRuleOutput"></bpel:invoke>
                <bpel:if name="If-manual-approval-is-required">
                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$evaluateBusinessRuleOutput.parameters/return/approval = 'false']]></bpel:condition>
                    <bpel:sequence>
                        <bpel:assign validate="no" name="Assign-order-details-input">
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>
                                        <tns:changeSalesOrderStatus
                                                xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0"
                                                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                            <order>
                                                <comments>comments</comments>
                                                <custDocumentNumber>custDocumentNumber</custDocumentNumber>
                                                <custDocumentType>custDocumentType</custDocumentType>
                                                <id>0</id>
                                                <orderDate>2001-12-31T12:00:00</orderDate>
                                                <price>0</price>
                                                <status>status</status>
                                            </order>
                                        </tns:changeSalesOrderStatus>
                                    </bpel:literal>
                                </bpel:from>
                                <bpel:to variable="updateOrderStatusInput" part="parameters"></bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>PENDING FOR MANUAL APPROVAL
                                    </bpel:literal>
                                </bpel:from>
                                <bpel:to part="parameters" variable="updateOrderStatusInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/comments]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>IN_VALIDATION</bpel:literal>
                                </bpel:from>
                                <bpel:to part="parameters" variable="updateOrderStatusInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/status]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="createOrderOutput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[return]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="updateOrderStatusInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/id]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        <bpel:invoke name="Invoke-update-order-comments" partnerLink="SalesOrderWSPartnerLink"
                                     operation="changeSalesOrderStatus" portType="so:SalesOrderWS"
                                     inputVariable="updateOrderStatusInput"></bpel:invoke>

                        <bpel:assign validate="no" name="Assign-manual-appoval-input">
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>
                                        <tschema:ClaimApprovalData
                                                xmlns:tschema="http://touresbalon.com.co/salesorder/schema/utility/1.0.0">
                                            <tschema:order>
                                                <tschema:id/>
                                                <tschema:custDocumentNumber/>
                                                <tschema:custDocumentType/>
                                                <tschema:customerType/>
                                            </tschema:order>
                                            <tschema:priority>1</tschema:priority>
                                        </tschema:ClaimApprovalData>
                                    </bpel:literal>
                                </bpel:from>
                                <bpel:to part="ClaimApprovalRequest" variable="claimInput"/>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="createOrderOutput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[return]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="ClaimApprovalRequest" variable="claimInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[htschema:order/htschema:id]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="payload" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/custDocumentNumber]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="ClaimApprovalRequest" variable="claimInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[htschema:order/htschema:custDocumentNumber]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="payload" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/custDocumentType]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="ClaimApprovalRequest" variable="claimInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[htschema:order/htschema:custDocumentType]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="payload" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[order/customerType]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="ClaimApprovalRequest" variable="claimInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[htschema:order/htschema:customerType]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        <bpel:sequence>
                            
                            
                            
                        
                            <bpel:assign validate="no" name="Assign-input-email"><bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Su orde esta en aprobacion manual</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[email:email/xsd:body]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Estado de la orden</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[email:email/xsd:subject]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
    
    
    

                            </bpel:assign>
                            <bpel:invoke name="Invoke-email-humantask" partnerLink="EmailServiceWSPartnerLink" operation="sendMailToCustomer" portType="email:IEmailService" inputVariable="emailSendInput" outputVariable="emailSendOutput"></bpel:invoke>
                        </bpel:sequence>
                        <bpel:extensionActivity>
                            <b4p:peopleActivity name="RemoteTask" inputVariable="claimInput" outputVariable="claimOutput" isSkipable="no">
                                <b4p:remoteTask partnerLink="b4pPartnerLink" operation="approve" responseOperation="approvalResponse"/>
                            </b4p:peopleActivity>
                        </bpel:extensionActivity>
                        <bpel:if name="If-order-is-not-approved">
                            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$claimOutput.ClaimApprovalResponse/htschema:approved = 'false']]></bpel:condition>
                            <bpel:sequence name="Sequence">
                                <bpel:assign validate="no" name="Assign-cancel-order-input">
                                    <bpel:copy>
                                        <bpel:from><bpel:literal><tns:changeSalesOrderStatus xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <order>
    <comments>comments</comments>
    <custDocumentNumber>custDocumentNumber</custDocumentNumber>
    <custDocumentType>custDocumentType</custDocumentType>
    <id>0</id>
    <orderDate>2001-12-31T12:00:00</orderDate>
    <price>0</price>
    <status>status</status>
  </order>
</tns:changeSalesOrderStatus>
</bpel:literal></bpel:from>
                                        <bpel:to variable="completeOrderStatusInput" part="parameters"></bpel:to>
                                    </bpel:copy>
                                    <bpel:copy>
                                        <bpel:from part="parameters" variable="createOrderOutput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="completeOrderStatusInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[order/id]]>
                                            </bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                    <bpel:copy>
                                        <bpel:from>
                                            <bpel:literal>THE ORDER WAS CANCELED BY AN BUSINESS ANALYST
</bpel:literal>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="completeOrderStatusInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order/comments]]></bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                    <bpel:copy>
                                        <bpel:from>
                                            <bpel:literal>CANCELED</bpel:literal>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="completeOrderStatusInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order/status]]></bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                </bpel:assign>
                                <bpel:invoke name="Invoke-cancel-order" partnerLink="SalesOrderWSPartnerLink" operation="changeSalesOrderStatus" portType="so:SalesOrderWS" inputVariable="completeOrderStatusInput"></bpel:invoke>
                                <bpel:exit name="Exit-cancel-order"></bpel:exit>
                            </bpel:sequence>
                        <bpel:elseif>
                                <bpel:empty name="Empty"></bpel:empty>
                            </bpel:elseif></bpel:if>
                    </bpel:sequence>
                    <bpel:else>
                        <bpel:empty name="Empty1"></bpel:empty>
                    </bpel:else>
                </bpel:if>
            </bpel:sequence>


            <bpel:assign validate="no" name="Assign-counters">
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>
                            <tns:IteratorCounter xmlns:tns="http://touresbalon.com.co/model/canonical/1.0.0">
                                <counter/>
                                <iterations/>
                            </tns:IteratorCounter>
                        </bpel:literal>
                    </bpel:from>
                    <bpel:to variable="counter"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>1</bpel:literal>
                    </bpel:from>
                    <bpel:to variable="counter">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[counter]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[count($input.payload/order/items)]]>
                    </bpel:from>
                    <bpel:to variable="counter">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[iterations]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>

		  <bpel:while name="While-Iterate-Over-Products">
                <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$counter/counter <= $counter/iterations]]></bpel:condition>

                <bpel:sequence name="Sequence-Product-Iterations">

                    <bpel:assign validate="no" name="Initialize-stock">

                        
                        <bpel:copy>
                            <bpel:from><bpel:literal><tns:stock xmlns:tns="http://touresbalon.com.co/model/canonical/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <completed>true</completed>
  <transport>
    <available>true</available>
    <travelNumber>travelNumber</travelNumber>
    <chairNumber>chairNumber</chairNumber>
    <observations>observations</observations>
  </transport>
  <lodging>
    <available>true</available>
    <hotel>hotel</hotel>
    <roomNumber>roomNumber</roomNumber>
    <observations>observations</observations>
    <reservationId>reservationId</reservationId>
  </lodging>
  <spectacle>
    <available>true</available>
    <ticket>ticket</ticket>
    <observations>observations</observations>
  </spectacle>
</tns:stock>
</bpel:literal></bpel:from>
                            <bpel:to variable="stock"></bpel:to>
                        </bpel:copy>
                        
                    </bpel:assign>


                    <bpel:assign validate="no" name="Initialize-item-update">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal><tns:updateItem xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <item>
    <id>0</id>
    <itemNo>itemNo</itemNo>
    <lodgingComments>lodgingComments</lodgingComments>
    <lodgingProvider>lodgingProvider</lodgingProvider>
    <lodgingReservationProvider>0</lodgingReservationProvider>
<transportTravelProvider></transportTravelProvider>
    <orderId>
      <comments>comments</comments>
      <custDocumentNumber>custDocumentNumber</custDocumentNumber>
      <custDocumentType>custDocumentType</custDocumentType>
      <id>0</id>
      <orderDate>2001-12-31T12:00:00</orderDate>
      <price>0</price>
      <status>status</status>
    </orderId>
    <price>0</price>
    <productId>0</productId>
    <productName>productName</productName>
    <spectacleComments>spectacleComments</spectacleComments>
    <spectacleId>0</spectacleId>
    <spectacleTicket>0</spectacleTicket>
    <status>status</status>
    <transportChairNumber>transportChairNumber</transportChairNumber>
    <transportComments>transportComments</transportComments>
    <transportOutTime>transportOutTime</transportOutTime>
    <transportSourceCity>transportSourceCity</transportSourceCity>
    <transportTargetCity>transportTargetCity</transportTargetCity>
    <transportTravelDate>2001-12-31T12:00:00</transportTravelDate>
    <transportTravelNumber>transportTravelNumber</transportTravelNumber>
  </item>
</tns:updateItem>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="updateItemInput" part="parameters"></bpel:to>
                        </bpel:copy>
                        
                    </bpel:assign>
                    <bpel:flow name="Flow">

                        <bpel:sequence name="VALIDATE_TRANSPORT">

                            <bpel:assign validate="no" name="Assign-validate-transport">
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>
                                            <tns:generateReservation
                                                    xmlns:tns="http://touresbalon.com.co/transport/service/task/1.0.0">
                                                <request>
                                                    <date/>
                                                    <provider/>
                                                    <sourceCity/>
                                                    <targetCity/>
                                                    <time/>
                                                </request>
                                            </tns:generateReservation>
                                        </bpel:literal>
                                    </bpel:from>
                                    <bpel:to variable="validateTransportInput" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelDate]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateTransportInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[request/date]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateTransportInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[request/provider]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/sourceCity]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateTransportInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[request/sourceCity]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/targetCity]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateTransportInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[request/targetCity]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelOutTime]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateTransportInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[request/time]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$updateItemInput.parameters/item/transportTravelProvider]]>
                                    </bpel:to>
                                </bpel:copy>
                            </bpel:assign>

                            <bpel:invoke name="Invoke-validate-transport" partnerLink="TransportWSPartnerLink"
                                         operation="generateReservation" portType="transport:TransportWS"
                                         inputVariable="validateTransportInput"
                                         outputVariable="validateTransportOutput"/>

                            <bpel:assign validate="no" name="Assign-output-transport">

                                <bpel:copy ignoreMissingFromData="yes">
                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/available]]>
                                        </bpel:query>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$stock/transport/available]]>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy ignoreMissingFromData="yes">
                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/chairNumber]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$stock/transport/chairNumber]]>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy ignoreMissingFromData="yes">
                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/description]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$stock/transport/observations]]>
                                    </bpel:to>
                                </bpel:copy>

                                <bpel:copy ignoreMissingFromData="yes">
                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/travelNumber]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        <![CDATA[$stock/transport/travelNumber]]>
                                    </bpel:to>
                                </bpel:copy>

                            </bpel:assign>
                        </bpel:sequence>
                        <bpel:sequence name="VALIDATE_LODGING">


                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <bpel:assign validate="no" name="Assign-validate-lodging">
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                <bpel:copy>
                                    <bpel:from><bpel:literal><tns:consultRoomsAvailability xmlns:tns="http://touresbalon.com.co/task/lodging/v1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <availabilityRequest>
    <hotelBrand>hotelBrand</hotelBrand>
    <checkIn>2001-01-01</checkIn>
    <checkOut>2001-01-01</checkOut>
    <city>city</city>
    <guestName>guestName</guestName>
  </availabilityRequest>
</tns:consultRoomsAvailability>
</bpel:literal></bpel:from>
                                    <bpel:to variable="validateLodgingInput" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/custFirstName]]>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$validateLodgingInput.parameters/availabilityRequest/guestName]]>
                                    </bpel:to>
                                
                                
                                
                                </bpel:copy>
                                <bpel:copy><bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/lodgingBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateLodgingInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[availabilityRequest/hotelBrand]]></bpel:query>
                                    </bpel:to>
                                
                                </bpel:copy>
                                <bpel:copy><bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/dateCheckIn]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateLodgingInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[availabilityRequest/checkIn]]></bpel:query>
                                    </bpel:to>
                                
                                </bpel:copy>
                                <bpel:copy><bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/dateCheckOut]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateLodgingInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[availabilityRequest/checkOut]]></bpel:query>
                                    </bpel:to>
                                
                                </bpel:copy>
                                <bpel:copy><bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/targetCity]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="validateLodgingInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[availabilityRequest/city]]></bpel:query>
                                    </bpel:to>
                                
                                </bpel:copy>
                            </bpel:assign>
                            <bpel:invoke name="Invoke-validate-lodging" partnerLink="LodgingWSPartnerLink" operation="consultRoomsAvailability" portType="lodging:LodgingPort" inputVariable="validateLodgingInput" outputVariable="validateLodgingOutput"></bpel:invoke>
                            
                            
                            <bpel:assign validate="no" name="Assign-output-lodging">
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/roomNumber]]>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$stock/lodging/roomNumber]]>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/reservationId]]>
                                    </bpel:from>
                                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$stock/lodging/reservationId]]>
                                    </bpel:to>
                                </bpel:copy>
                                
                            </bpel:assign>
                        </bpel:sequence>
                        <bpel:sequence name="VALIDATE_SPECTACLE">

                            <bpel:assign validate="no" name="Assign-validate-spectacle">
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>
                                            <tns:searchTicketByIdSpectacle
                                                    xmlns:tns="http://spectacles.com.co/service/task/1.0.0"
                                                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                                <idSpectacle>0</idSpectacle>
                                            </tns:searchTicketByIdSpectacle>
                                        </bpel:literal>
                                    </bpel:from>
                                    <bpel:to variable="searchTicketInput" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/spectacle/id]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="searchTicketInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[idSpectacle]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                            </bpel:assign>
                            <bpel:invoke name="Invoke-validate-spectacle" partnerLink="SpectaclesWSPartnerLink"
                                         operation="searchTicketByIdSpectacle" portType="spectacle:SpectaclesWS"
                                         inputVariable="searchTicketInput"
                                         outputVariable="searchTicketOutput"></bpel:invoke>
                            <bpel:assign validate="no" name="Assign-output-spectacle">
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="searchTicketOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/transactionSuccess]]>
                                        </bpel:query>
                                    </bpel:from>
                                    <bpel:to variable="stock">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[spectacle/available]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="searchTicketOutput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[return/ticket]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to variable="stock">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[spectacle/ticket]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>

                            </bpel:assign>
                        </bpel:sequence>
</bpel:flow>


                    <!-- ================================================================= -->
                    <!-- COMPENSATION ACTIVITY                                             -->
                    <!-- Compensate not provisioned products                               -->
                    <!-- ================================================================= -->

                    <bpel:assign validate="no" name="Assign-journal-entry-and-item-detail">
                        
                        <bpel:copy>
                            <bpel:from queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
                                       expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">
                                <![CDATA[ode:insert-as-last-into($journal, $stock)]]>
                            </bpel:from>
                            <bpel:to variable="journal"/>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[round($counter/counter)]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/itemNo]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="createOrderOutput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/orderId/id]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal>NOT_PROVISIONED</bpel:literal>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/status]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter)]/price]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/price]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:assign validate="no" name="Assign-validated-transport-info">
                        <bpel:copy>
                            <bpel:from part="parameters" variable="validateTransportOutput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[return/travelNumber]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportTravelNumber]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="validateTransportOutput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[return/chairNumber]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportChairNumber]]>
                                </bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/travelOutTime]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportOutTime]]>
                                </bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/sourceCity]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportSourceCity]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/targetCity]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportTargetCity]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/travelDate]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/transportTravelDate]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>

                        
                    </bpel:assign>
                    <bpel:assign validate="no" name="Assign-validated-spectacle-info">
                        <bpel:copy ignoreMissingFromData="yes">
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                <![CDATA[$input.payload/order/items[round($counter/counter) ]/spectacle/id]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/spectacleId]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy ignoreMissingFromData="yes">
                            <bpel:from part="parameters" variable="searchTicketOutput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[return/ticket]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[item/spectacleTicket]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>

                    </bpel:assign>
                    <bpel:if name="If-compensation-required">
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$validateTransportOutput.parameters/return/available = 'false' or $searchTicketOutput.parameters/return/transactionSuccess = 'false' or $validateLodgingOutput.parameters/return/lodging2:room/reservationId = 0]]></bpel:condition>
                        <bpel:sequence name="COMPENSATION-FLOW">

                            <bpel:flow name="Flow2">
                                <bpel:sequence name="COMPENSATE_TRANSPORT">

                                    <bpel:assign validate="no" name="Assign-item-detail">
                                        <bpel:copy>
                                            <bpel:from part="parameters" variable="validateTransportOutput">
                                                <bpel:query
                                                        queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[return/description]]></bpel:query>
                                            </bpel:from>
                                            <bpel:to part="parameters" variable="updateItemInput">
                                                <bpel:query
                                                        queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[item/transportComments]]></bpel:query>
                                            </bpel:to>
                                        </bpel:copy>

                                    </bpel:assign>
                                    <bpel:if name="If-compensate-reservation">
                                        <bpel:condition
                                                expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[$validateTransportOutput.parameters/return/available = 'true']]></bpel:condition>
                                        <bpel:sequence>
                                            <bpel:assign validate="no" name="Assign-cancel-transport">
                                                <bpel:copy>
                                                    <bpel:from>
                                                        <bpel:literal>
                                                            <tns:cancelReservation
                                                                    xmlns:tns="http://touresbalon.com.co/transport/service/task/1.0.0"
                                                                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                                                <reservation>
                                                                    <chairNumber>chairNumber</chairNumber>
                                                                    <outTime>outTime</outTime>
                                                                    <sourceCity>sourceCity</sourceCity>
                                                                    <targetCity>targetCity</targetCity>
                                                                    <travelNumber>travelNumber</travelNumber>
                                                                </reservation>
                                                                <travelDate>2001-12-31T12:00:00</travelDate>
                                                                <provider>BOLIVARIANO</provider>
                                                            </tns:cancelReservation>
                                                        </bpel:literal>
                                                    </bpel:from>
                                                    <bpel:to variable="compTransportInput" part="parameters"></bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[return/chairNumber]]></bpel:query>
                                                    </bpel:from>

                                                    <bpel:to part="parameters" variable="compTransportInput">

                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[reservation/chairNumber]]>
                                                        </bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>

                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                        <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/travelOutTime]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[reservation/outTime]]>
                                                        </bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                        <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/sourceCity]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[reservation/sourceCity]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                        <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/targetCity]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[reservation/targetCity]]>
                                                        </bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from part="parameters" variable="validateTransportOutput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[return/travelNumber]]></bpel:query>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[reservation/travelNumber]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelDate]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[travelDate]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                        <![CDATA[$input.payload/order/items[round($counter/counter) ]/transport/travelBusinessProvider]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compTransportInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[provider]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>


                                                
                                            </bpel:assign>

                                            <bpel:invoke name="Invoke-cancel-transport"
                                                         partnerLink="TransportWSPartnerLink"
                                                         operation="cancelReservation" portType="transport:TransportWS"
                                                         inputVariable="compTransportInput"></bpel:invoke>

                                        </bpel:sequence>
                                        <bpel:else>
                                            <bpel:assign validate="no" name="Assign-Comment">
                                                <bpel:copy>
                                                    <bpel:from>
                                                        <bpel:literal>THERE IS NOT AVAILABLE TRANSPORT</bpel:literal>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="updateItemInput">
                                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/transportComments]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                            </bpel:assign>
                                        </bpel:else>
                                    </bpel:if>
                                </bpel:sequence>

                                <bpel:sequence name="COMPENSATE_LODGING">
                                    
                                    
                                    
                                    
                                    
                                    
                                    <bpel:assign validate="no" name="Assign-item-detail">
                                        <bpel:copy>
                                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                
                                                <![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/type]]>
                                            </bpel:from>
                                            <bpel:to part="parameters" variable="updateItemInput">
                                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingComments]]></bpel:query>
                                            </bpel:to>
                                        </bpel:copy>
                                    </bpel:assign>
                                    <bpel:if name="If-compensate-lodging">
                                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/reservationId = 0]]></bpel:condition>
                                        <bpel:sequence name="Sequence">
                                            <bpel:assign validate="no" name="Assign-cancel-lodging">
                                                <bpel:copy>
                                                    <bpel:from><bpel:literal><tns:cancelReservation xmlns:tns="http://touresbalon.com.co/task/lodging/v1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cancelReservationRequest>
    <reservationId>0</reservationId>
  </cancelReservationRequest>
</tns:cancelReservation>
</bpel:literal></bpel:from>
                                                    <bpel:to variable="compLodgingInput" part="parameters"></bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        
                                                        <![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/reservationId]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="compLodgingInput">
                                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[cancelReservationRequest/reservationId]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                
                                            </bpel:assign>
                                            <bpel:invoke name="Invoke-cancel-lodging" partnerLink="LodgingWSPartnerLink" operation="cancelReservation" portType="lodging:LodgingPort" inputVariable="compLodgingInput" outputVariable="compLodgingOutput"></bpel:invoke>
                                        </bpel:sequence>
                                        <bpel:else>
                                            <bpel:assign validate="no" name="Assing-Comments">
                                                <bpel:copy>
                                                    <bpel:from>
                                                        <bpel:literal>THERE IS NOT AVAILABLE ROOM</bpel:literal>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="updateItemInput">
                                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingComments]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                            </bpel:assign>
                                        </bpel:else>
                                    </bpel:if>
                                </bpel:sequence>
                                <bpel:sequence name="COMPENSATE_SPECTACLE">

                                    <bpel:assign validate="no" name="Assign-item-detail">
                                        <bpel:copy>
                                            <bpel:from>
                                                <bpel:literal>NO TICKET AVAILABLE</bpel:literal>
                                            </bpel:from>
                                            <bpel:to part="parameters" variable="updateItemInput">
                                                <bpel:query
                                                        queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[item/spectacleComments]]></bpel:query>
                                            </bpel:to>
                                        </bpel:copy>

                                    </bpel:assign>
                                    <bpel:if name="If-compensate-spectacle">
                                        <bpel:condition
                                                expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[$searchTicketOutput.parameters/return/transactionSuccess = 'true']]></bpel:condition>
                                        <bpel:sequence>

                                            <bpel:assign validate="no" name="Assign-cancel-spectacle">
                                                <bpel:copy>
                                                    <bpel:from>
                                                        <bpel:literal>
                                                            <tns:cancelSpectacleReservation
                                                                    xmlns:tns="http://spectacles.com.co/service/task/1.0.0"
                                                                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                                                <idSpectacle>0</idSpectacle>
                                                                <idTicket>0</idTicket>
                                                            </tns:cancelSpectacleReservation>
                                                        </bpel:literal>
                                                    </bpel:from>
                                                    <bpel:to variable="cancelSpectacleInput"
                                                             part="parameters"></bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from part="parameters" variable="searchTicketOutput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[return/ticket]]></bpel:query>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="cancelSpectacleInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[idTicket]]>
                                                        </bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                <bpel:copy>
                                                    <bpel:from
                                                            expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/spectacle/id]]>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="cancelSpectacleInput">
                                                        <bpel:query
                                                                queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                            <![CDATA[idSpectacle]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                                
                                            </bpel:assign>


                                            <bpel:invoke name="Invoke-cancel-spectacle"
                                                         partnerLink="SpectaclesWSPartnerLink"
                                                         operation="cancelSpectacleReservation"
                                                         portType="spectacle:SpectaclesWS"
                                                         inputVariable="cancelSpectacleInput"
                                                         outputVariable="cancelSpectacleOutput"></bpel:invoke>
                                        </bpel:sequence>
                                        <bpel:else>
                                            <bpel:assign validate="no" name="Assign-Comments">
                                                <bpel:copy>
                                                    <bpel:from>
                                                        <bpel:literal>THERE IS NOT AVAILABLE SPECTACLE</bpel:literal>
                                                    </bpel:from>
                                                    <bpel:to part="parameters" variable="updateItemInput">
                                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/spectacleComments]]></bpel:query>
                                                    </bpel:to>
                                                </bpel:copy>
                                            </bpel:assign>
                                        </bpel:else>
                                    </bpel:if>
                                </bpel:sequence>
                            </bpel:flow>
                        </bpel:sequence>
                        <bpel:else>
                            <bpel:sequence name="STANDAR-FLOW">


                                
                                <bpel:assign validate="no" name="Assign-item-provisioned-details">

                                    <bpel:copy>
                                        <bpel:from>
                                            <bpel:literal>PROVISIONED</bpel:literal>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="updateItemInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[item/status]]></bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                    <bpel:copy>
                                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            <![CDATA[$validateLodgingInput.parameters/availabilityRequest/hotelBrand]]>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="updateItemInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingProvider]]></bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                    <bpel:copy>
                                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            <![CDATA[$validateLodgingOutput.parameters/return]]>
                                        </bpel:from>
                                        <bpel:to part="parameters" variable="updateItemInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingReservationProvider]]></bpel:query>
                                        </bpel:to>
                                    </bpel:copy>
                                </bpel:assign>
                            </bpel:sequence>
                        </bpel:else>
                    </bpel:if>


                    <bpel:assign validate="no" name="Assign-increment-counter">
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$counter/counter+1]]>
                            </bpel:from>
                            <bpel:to variable="counter">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[counter]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>

                    <bpel:assign validate="no" name="Assign-Update-item">
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$validateLodgingInput.parameters/availabilityRequest/hotelBrand]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingProvider]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                <![CDATA[$validateLodgingOutput.parameters/return/lodging2:room/reservationId]]>
                            </bpel:from>
                            <bpel:to part="parameters" variable="updateItemInput">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[item/lodgingReservationProvider]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke-update-item" partnerLink="SalesOrderWSPartnerLink" operation="updateItem"
                                 portType="so:SalesOrderWS" inputVariable="updateItemInput"></bpel:invoke>
                </bpel:sequence>
            </bpel:while>

            <bpel:sequence name="PREPARE_ORDER_TO_PROV_STAGE">


                
                
                <bpel:empty name="Empty-provisioning-activity-stage"></bpel:empty>
            </bpel:sequence>

        </bpel:sequence>


        <!-- ================================================================= -->
        <!-- PROVISIONING STAGE                                                -->
        <!-- Stage required to process de product provisioning                 -->
        <!-- ================================================================= -->

        <bpel:sequence name="PROVISIONING_STAGE">

            <bpel:assign validate="no" name="Assign-clean-counters">
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>1</bpel:literal>
                    </bpel:from>
                    <bpel:to variable="counter">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[counter]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>


            <bpel:while name="While-Iterate-Over-Products">
                <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$counter/counter <= $counter/iterations]]></bpel:condition>

                <bpel:sequence name="Sequence-Product-Iterations">

                    <bpel:if name="If-apply-provisioning-to-iteration">
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$journal/canonical:stock[ round($counter/counter) ]/transport/available ='true' and $journal/canonical:stock[ round($counter/counter) ]/spectacle/available = 'true']]></bpel:condition>
                        <bpel:sequence>

                            <bpel:flow name="PROVISIONING_FLOW">
                                <bpel:sequence name="PROVISIONING_TRANSPORT">
                                    


                                    <bpel:sequence>
                                        <bpel:assign validate="no" name="Assign-confirm-transport">
                                            <bpel:copy>
                                                <bpel:from><bpel:literal><tns:confirmTravel xmlns:tns="http://touresbalon.com.co/transport/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <orderId>0.0</orderId>
  <confirmations>
    <chairNumber>chairNumber</chairNumber>
    <firstName>firstName</firstName>
    <lastName>lastName</lastName>
    <outDate>2001-12-31T12:00:00</outDate>
    <provider>BOLIVARIANO</provider>
    <travelNumber>travelNumber</travelNumber>
  </confirmations>
</tns:confirmTravel>
</bpel:literal></bpel:from>
                                                <bpel:to variable="confirmTransportInput" part="parameters"></bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[$journal/canonical:stock[ round($counter/counter) ]/transport/chairNumber]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/chairNumber]]></bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[$journal/canonical:stock[ round($counter/counter) ]/transport/travelNumber]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/travelNumber]]></bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from part="payload" variable="input">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[order/custFirstName]]></bpel:query>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/firstName]]></bpel:query>
                                                </bpel:to>
                                            </bpel:copy>


                                            <bpel:copy>
                                                <bpel:from part="payload" variable="input">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[order/custLastName]]></bpel:query>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/lastName]]></bpel:query>
                                                </bpel:to>

                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelDate]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/outDate]]>
                                                    </bpel:query>
                                                </bpel:to>

                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelBusinessProvider]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmTransportInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[confirmations/provider]]>
                                                    </bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            
                                            
                                        </bpel:assign>
                                        <bpel:invoke name="Invoke-confirm-transport" partnerLink="TransportWSPartnerLink" operation="confirmTravel" portType="transport:TransportWS" inputVariable="confirmTransportInput"></bpel:invoke>

                                    
                                    </bpel:sequence>
                                </bpel:sequence>

                                <bpel:sequence name="PROVISIONING_LODGING">
                                    
                                    <bpel:sequence name="Sequence">
                                        
                                        
                                        <bpel:assign validate="no" name="Assign-confirm-lodging">
                                            <bpel:copy>
                                                <bpel:from><bpel:literal><tns:confirmReservation xmlns:tns="http://touresbalon.com.co/task/lodging/v1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <confirmReservationRequest>
    <reservationId>0</reservationId>
  </confirmReservationRequest>
</tns:confirmReservation>
</bpel:literal></bpel:from>
                                                <bpel:to variable="confirmLodgingInput" part="parameters"></bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    <![CDATA[$journal/canonical:stock[ round($counter/counter) ]/lodging/reservationId]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmLodgingInput">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[confirmReservationRequest/reservationId]]></bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            
                                        </bpel:assign>
                                        <bpel:invoke name="Invoke-confirm-lodging" partnerLink="LodgingWSPartnerLink" operation="confirmReservation" portType="lodging:LodgingPort" inputVariable="confirmLodgingInput" outputVariable="conformLodgingOutput"></bpel:invoke>
                                    </bpel:sequence>
                                </bpel:sequence>


                                <bpel:sequence name="PROVISIONING_SPECTACLE">

                                    <bpel:sequence name="Sequence">
                                        <bpel:assign validate="no" name="Assign-confirm-spectacle">
                                            <bpel:copy>
                                                <bpel:from>
                                                    <bpel:literal>
                                                        <tns:buySpectacleByTicket
                                                                xmlns:tns="http://spectacles.com.co/service/task/1.0.0"
                                                                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                                            <idSpectacle>0</idSpectacle>
                                                            <idTicket>0</idTicket>
                                                        </tns:buySpectacleByTicket>
                                                    </bpel:literal>
                                                </bpel:from>
                                                <bpel:to variable="confirmSpectacleInput" part="parameters"></bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from
                                                        expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                    <![CDATA[$input.payload/order/items[ round($counter/counter) ]/spectacle/id]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmSpectacleInput">
                                                    <bpel:query
                                                            queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[idSpectacle]]>
                                                    </bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            <bpel:copy>
                                                <bpel:from
                                                        expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">


                                                    <![CDATA[$journal/canonical:stock[ round($counter/counter) ]/spectacle/ticket]]>
                                                </bpel:from>
                                                <bpel:to part="parameters" variable="confirmSpectacleInput">
                                                    <bpel:query
                                                            queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                        <![CDATA[idTicket]]></bpel:query>
                                                </bpel:to>
                                            </bpel:copy>
                                            
                                        </bpel:assign>
                                        <bpel:invoke name="Invoke-confirm-spectacle" partnerLink="SpectaclesWSPartnerLink"
                                                     operation="buySpectacleByTicket" portType="spectacle:SpectaclesWS"
                                                     inputVariable="confirmSpectacleInput"
                                                     outputVariable="confirmSpectacleOutput"></bpel:invoke>

                                    </bpel:sequence>

                                </bpel:sequence>
                            </bpel:flow>
                            <bpel:sequence name="AccountingMicrofocus">
                                <bpel:assign validate="no" name="AssignAccountingcomplete"><bpel:copy>
                    <bpel:from><bpel:literal><tns:AccountTransaction xmlns:tns="http://touresbalon.com.co/accounting/service/entity/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:TransactionNumber>tns:TransactionNumber</tns:TransactionNumber>
  <tns:TransportProvider>tns:TransportProvider</tns:TransportProvider>
  <tns:LodgingProvider>tns:LodgingProvider</tns:LodgingProvider>
  <tns:WithdrawalAmount>0.0</tns:WithdrawalAmount>
  <tns:DepositAmount>0.0</tns:DepositAmount>
</tns:AccountTransaction></bpel:literal></bpel:from>
                    <bpel:to variable="createCompletedOrderInput" part="payload"></bpel:to>
                </bpel:copy>
                
                
                
                
                
    
    
    
    
    

                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createCompletedOrderInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[microfocus:TransportProvider]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$createOrderOutput.parameters/return]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createCompletedOrderInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[microfocus:TransactionNumber]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/price]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createCompletedOrderInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[microfocus:DepositAmount]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/lodgingBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createCompletedOrderInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[microfocus:LodgingProvider]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                
                            </bpel:assign>
                                <bpel:invoke name="InvokeAccountingComplete" partnerLink="MicrofocusWSPartnerLink" operation="createCompletedOrder" portType="microfocus:MicrofocusAdapterPortType" inputVariable="createCompletedOrderInput"></bpel:invoke>
                                <bpel:assign validate="no" name="AssignPaymentComplete"><bpel:copy>
                                    <bpel:from><bpel:literal><tns:AccountTransaction xmlns:tns="http://touresbalon.com.co/accounting/service/entity/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:TransactionNumber>tns:TransactionNumber</tns:TransactionNumber>
  <tns:TransportProvider>tns:TransportProvider</tns:TransportProvider>
  <tns:LodgingProvider>tns:LodgingProvider</tns:LodgingProvider>
  <tns:WithdrawalAmount>0.0</tns:WithdrawalAmount>
  <tns:DepositAmount>0.0</tns:DepositAmount>
</tns:AccountTransaction>
</bpel:literal></bpel:from>
                                    <bpel:to variable="createExecutedPaymentInput" part="payload"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/transport/travelBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createExecutedPaymentInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[microfocus:TransportProvider]]>
                                            </bpel:query>
                                        </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$createOrderOutput.parameters/return]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createExecutedPaymentInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[microfocus:TransactionNumber]]>
                                            </bpel:query>
                                        </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/price]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createExecutedPaymentInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[microfocus:WithdrawalAmount]]>
                                            </bpel:query>
                                        </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/order/items[round($counter/counter)]/lodging/lodgingBusinessProvider]]>
                                    </bpel:from>
                                    <bpel:to part="payload" variable="createExecutedPaymentInput">
                                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[microfocus:LodgingProvider]]>
                                            </bpel:query>
                                        </bpel:to>
                                </bpel:copy>
                            
                                </bpel:assign>
                                <bpel:invoke name="InvokeExecutePayment" partnerLink="MicrofocusWSPartnerLink" operation="createExecutedPayment" portType="microfocus:MicrofocusAdapterPortType" inputVariable="createExecutedPaymentInput"></bpel:invoke>
                            </bpel:sequence>
                            
                            
                            
                            
                        </bpel:sequence>
                    </bpel:if>


                    <bpel:assign validate="no" name="Assign-increment-counter">
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$counter/counter+1]]>
                            </bpel:from>
                            <bpel:to variable="counter">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[counter]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>

                </bpel:sequence>
            </bpel:while>


            <bpel:assign validate="no" name="Assign-payment-input">
                <bpel:copy>
                    <bpel:from><bpel:literal><tns:executeTransaction xmlns:tns="http://redeban.com/creditcards/ws" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <transaction>
    <amount>0.0</amount>
    <identificationType>identificationType</identificationType>
    <number>number</number>
    <numberIdentification>numberIdentification</numberIdentification>
  </transaction>
</tns:executeTransaction>
</bpel:literal></bpel:from>
                    <bpel:to variable="executePaymentInput" part="parameters"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/custDocumentNumber]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="executePaymentInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[transaction/numberIdentification]]>
                        </bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/custDocumentType]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="executePaymentInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[transaction/identificationType]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$input.payload/order/price]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="executePaymentInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[transaction/amount]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        
                        
                        
                        
                        
                        
                        
                        
                        <![CDATA[$createOrderOutput.parameters/return]]>
                    </bpel:from>
                    <bpel:to part="parameters" variable="executePaymentInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[transaction/number]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>
            <bpel:invoke name="Invoke-Payment-creditcard" partnerLink="CreditCardPartnerLink" operation="executeTransaction" portType="credit:CreditCard" inputVariable="executePaymentInput"></bpel:invoke>
        </bpel:sequence>

        <bpel:sequence name="NOTIFICATION_STAGE">
            <bpel:assign validate="no" name="Assign-order-details">
                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>
                            <tns:changeSalesOrderStatus xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0">
                                <order>
                                    <comments>comments</comments>
                                    <id>0</id>
                                    <orderDate>2001-12-31T12:00:00</orderDate>
                                    <price>0</price>
                                    <status>status</status>
                                </order>
                            </tns:changeSalesOrderStatus>
                        </bpel:literal>
                    </bpel:from>
                    <bpel:to variable="completeOrderStatusInput" part="parameters"/>
                </bpel:copy>

                <bpel:copy>
                    <bpel:from part="parameters" variable="createOrderOutput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[return]]></bpel:query>
                    </bpel:from>
                    <bpel:to part="parameters" variable="completeOrderStatusInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[order/id]]>
                        </bpel:query>
                    </bpel:to>
                </bpel:copy>

                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>CLOSED</bpel:literal>
                    </bpel:from>
                    <bpel:to part="parameters" variable="completeOrderStatusInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[order/status]]></bpel:query>
                    </bpel:to>
                </bpel:copy>

                <bpel:copy>
                    <bpel:from>
                        <bpel:literal>SALES ORDER WAS PROCESSED SUCCESSFULLY</bpel:literal>
                    </bpel:from>
                    <bpel:to part="parameters" variable="completeOrderStatusInput">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[order/comments]]></bpel:query>
                    </bpel:to>
                </bpel:copy>

            </bpel:assign>

            <bpel:invoke name="Invoke-sales-order-complete-status" partnerLink="SalesOrderWSPartnerLink"
                         operation="changeSalesOrderStatus" portType="so:SalesOrderWS"
                         inputVariable="completeOrderStatusInput"/>

            
            
            
            <bpel:sequence name="Sequence">
                
                        
    
    
    
    

                <bpel:assign validate="no" name="Assign-input-email"><bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Su orden esta esta lista</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:body]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from>
                                        <bpel:literal>Estado de la orden</bpel:literal>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="emailSendInput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[email:email/xsd:subject]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
    
    
    

                </bpel:assign>
                <bpel:invoke name="Invoke-email-success" partnerLink="EmailServiceWSPartnerLink" operation="sendMailToCustomer" portType="email:IEmailService" inputVariable="emailSendInput" outputVariable="emailSendOutput"></bpel:invoke>
            </bpel:sequence>
        </bpel:sequence>
    </bpel:sequence>

</bpel:process>

