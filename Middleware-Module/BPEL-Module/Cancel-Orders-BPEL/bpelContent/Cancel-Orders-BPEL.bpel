<!-- Cancel-Orders-BPEL BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Mon Mar 05 12:13:11 IST 2012 -->
<bpel:process name="Cancel-Orders-BPEL"
         targetNamespace="http://touresbalon.com.co/orders/service/task/1.0.0"
         suppressJoinFailure="yes"
         xmlns:tns="http://touresbalon.com.co/orders/service/task/1.0.0"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://touresbalon.com.co/salesorder/service/task/1.0.0" xmlns:ns2="http://touresbalon.com.co/transport/service/task/1.0.0">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://touresbalon.com.co/transport/service/task/1.0.0" location="wsdl/TransportWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://touresbalon.com.co/salesorder/service/task/1.0.0" location="wsdl/SalesOrderWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import location="Cancel-Orders-BPELArtifacts.wsdl" namespace="http://touresbalon.com.co/orders/service/task/1.0.0" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:Cancel-Orders-BPEL"
                     myRole="Cancel-Orders-BPELProvider"
                     />
        
        <bpel:partnerLink name="PartnerLinkSalesOrderWS" 
        partnerLinkType="ns1:SalesOrderWS_PLT" partnerRole="SalesOrderWS_Role"
        initializePartnerRole="yes"/>
        
        <bpel:partnerLink name="PartnerLinkTransportWS" 
        partnerLinkType="ns2:TransportWS_PLT" partnerRole="TransportWS_Role"
        initializePartnerRole="yes"/>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                  messageType="tns:Cancel-Orders-BPELRequestMessage"/>
                  
    
        <bpel:variable name="getOrderInput" messageType="ns1:searchSalesOrderById"></bpel:variable>
        <bpel:variable name="getOrderOutput" messageType="ns1:searchSalesOrderByIdResponse"></bpel:variable>
        <bpel:variable name="updateOrderInput" messageType="ns1:changeSalesOrderStatus"></bpel:variable>
        <bpel:variable name="counter" element="tns:IteratorCounter"></bpel:variable>
        <bpel:variable name="cancelTransportinput" messageType="ns2:cancelReservation"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main"><!-- Receive input from requester. 
             Note: This maps to operation defined in Cancel-Orders-BPEL.wsdl 
             -->
        <bpel:receive name="receiveInput" partnerLink="client" portType="tns:Cancel-Orders-BPEL" operation="process" variable="input" createInstance="yes" />
    
        <bpel:assign validate="no" name="Assign-get-order-input">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:searchSalesOrderById xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <salesOrderId>0</salesOrderId>
</tns:searchSalesOrderById>
</bpel:literal></bpel:from>
                <bpel:to variable="getOrderInput" part="parameters"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderId]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="getOrderInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[salesOrderId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        
        <bpel:invoke name="Invoke-get-order" partnerLink="PartnerLinkSalesOrderWS" operation="searchSalesOrderById" portType="ns1:SalesOrderWS" inputVariable="getOrderInput" outputVariable="getOrderOutput"></bpel:invoke>
        
        <!-- Generate reply to synchronous request -->
        
        <bpel:assign validate="no" name="Assign-counter">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:IteratorCounter xmlns:tns="http://touresbalon.com.co/orders/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:counter>0</tns:counter>
  <tns:iterations>0</tns:iterations>
</tns:IteratorCounter>
</bpel:literal></bpel:from>
                <bpel:to variable="counter"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>1</bpel:literal>
                </bpel:from>
                <bpel:to variable="counter">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:counter]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    
                    
                    
                    
                    
                    
                    
                    
                    <![CDATA[count($getOrderOutput.parameters/return/orderItemList)]]>
                </bpel:from>
                <bpel:to variable="counter">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:iterations]]></bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:while name="While-iterate-over-products">
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$counter/tns:counter <= $counter/tns:iterations]]></bpel:condition>
            <bpel:sequence>
                <bpel:if name="If-status-is-provisioned">
                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$getOrderOutput.parameters/return/orderItemList[ round( $counter/tns:counter) ]/status = 'PROVISIONED']]></bpel:condition>
                    <bpel:flow name="Flow">
                <bpel:sequence name="CANCEL-TRANSPORT">
                            <bpel:assign validate="no" name="Assign-message-transport">
                                <bpel:copy>
                                    <bpel:from><bpel:literal><tns:cancelReservation xmlns:tns="http://touresbalon.com.co/transport/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <reservation>
    <chairNumber>chairNumber</chairNumber>
    <outTime>outTime</outTime>
    <sourceCity>sourceCity</sourceCity>
    <targetCity>targetCity</targetCity>
    <travelNumber>travelNumber</travelNumber>
  </reservation>
  <travelDate>2001-12-31T12:00:00</travelDate>
  <provider>BOLIVARIANO</provider>
</tns:cancelReservation>
</bpel:literal></bpel:from>
                                    <bpel:to variable="cancelTransportinput" part="parameters"></bpel:to>
                                </bpel:copy>
                                
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportChairNumber]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[reservation/chairNumber]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportOutTime]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[reservation/outTime]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportSourceCity]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[reservation/sourceCity]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportTargetCity]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[reservation/targetCity]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportTravelNumber]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[reservation/travelNumber]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportTravelDate]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[travelDate]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                
                                
                                <bpel:copy>
                                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        
                                        <![CDATA[$getOrderOutput.parameters/return/orderItemList[round($counter/tns:counter)]/transportTravelProvider]]>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="cancelTransportinput">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[provider]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                
                            </bpel:assign>
                            <bpel:invoke name="Invoke-cancel-transport" partnerLink="PartnerLinkTransportWS" operation="cancelReservation" portType="ns2:TransportWS" inputVariable="cancelTransportinput"></bpel:invoke>
                            <bpel:empty name="cancel-transport-activity"></bpel:empty>
            
                </bpel:sequence>
                <bpel:sequence name="CANCEL-SPECTACLE">
                
                <bpel:empty name="cancel-spectacle-activity"></bpel:empty>
            </bpel:sequence>
                <bpel:sequence name="CANCEL-LODGING">
                <bpel:empty name="cancel-lodging-activity"></bpel:empty>
            </bpel:sequence></bpel:flow>
                </bpel:if>
                
                <bpel:assign validate="no" name="Assign-increment">
                    
                    <bpel:copy>
                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            
                            
                            
                            
                            
                            
                            
                            <![CDATA[$counter/tns:counter +1]]>
                        </bpel:from>
                        <bpel:to variable="counter">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:counter]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
            </bpel:sequence>
        </bpel:while>
        
        <bpel:assign validate="no" name="Assign-order-details">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:changeSalesOrderStatus xmlns:tns="http://touresbalon.com.co/salesorder/service/task/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <order>
    <comments>comments</comments>
    <custDocumentNumber>custDocumentNumber</custDocumentNumber>
    <custDocumentType>custDocumentType</custDocumentType>
    <id>0</id>
    <orderDate>2001-12-31T12:00:00</orderDate>
    <orderItemList>
      <id>0</id>
      <itemNo>itemNo</itemNo>
      <lodgingComments>lodgingComments</lodgingComments>
      <orderId></orderId>
      <price>0</price>
      <productId>0</productId>
      <productName>productName</productName>
      <spectacleComments>spectacleComments</spectacleComments>
      <spectacleId>0</spectacleId>
      <spectacleTicket>0</spectacleTicket>
      <status>status</status>
      <transportChairNumber>transportChairNumber</transportChairNumber>
      <transportComments>transportComments</transportComments>
      <transportOutTime>transportOutTime</transportOutTime>
      <transportSourceCity>transportSourceCity</transportSourceCity>
      <transportTargetCity>transportTargetCity</transportTargetCity>
      <transportTravelDate>2001-12-31T12:00:00</transportTravelDate>
      <transportTravelNumber>transportTravelNumber</transportTravelNumber>
    </orderItemList>
    <price>0</price>
    <status>status</status>
  </order>
</tns:changeSalesOrderStatus>
</bpel:literal></bpel:from>
                <bpel:to variable="updateOrderInput" part="parameters"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderId]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="updateOrderInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[order/id]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>REJECTED</bpel:literal>
                </bpel:from>
                <bpel:to part="parameters" variable="updateOrderInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order/status]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>THE ORDER WAS REJECTED</bpel:literal>
                </bpel:from>
                <bpel:to part="parameters" variable="updateOrderInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order/comments]]></bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:invoke name="Invoke-update-order-status" partnerLink="PartnerLinkSalesOrderWS" operation="changeSalesOrderStatus" portType="ns1:SalesOrderWS" inputVariable="updateOrderInput"></bpel:invoke>
        
    
    </bpel:sequence>
</bpel:process>

